<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rangrez Matrimony - Complete Your Profile</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #FAF3E0, #FFE8B6);
      color: #333333;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      flex: 1;
      padding: 6vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .card {
      width: 100%;
      max-width: 450px;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      padding: 6vw;
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .progress-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 5vw;
    }
    .progress-bar {
      width: 100%;
      background: #e0e0e0;
      height: 0.8rem;
      border-radius: 0.4rem;
      overflow: hidden;
    }
    .progress {
      background: linear-gradient(to right, #800000, #FFD700);
      height: 100%;
      width: 16.67%;
      transition: width 0.4s ease;
    }
    .step-indicators {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 2vw;
    }
    .step-indicator {
      width: 10px;
      height: 10px;
      background: #ccc;
      border-radius: 50%;
      transition: background 0.3s ease;
    }
    .step-indicator.active {
      background: #FFD700;
    }
    #step-text {
      text-align: center;
      margin: 3vw 0;
      color: #800000;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .step {
      display: flex;
      flex-direction: column;
      gap: 4vw;
      animation: slideIn 0.4s ease;
    }
    .hidden {
      display: none;
    }
    .form-group {
      position: relative;
    }
    label {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 2vw;
      color: #800000;
    }
    input, select {
      width: 100%;
      padding: 3.5vw;
      border: 2px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      border-color: #FFD700;
      outline: none;
    }
    .valid {
      border-color: #28a745 !important;
    }
    .invalid {
      border-color: #dc3545 !important;
    }
    .radio-group {
      display: flex;
      gap: 5vw;
      flex-wrap: wrap;
      align-items: center;
    }
    input[type="radio"] {
      margin-right: 1vw;
    }
    .error {
      color: #dc3545;
      font-size: 0.9rem;
      margin-top: 1vw;
      text-align: center;
    }
    .navigation {
      display: flex;
      justify-content: space-between;
      gap: 3vw;
      margin-top: 5vw;
    }
    button {
      flex: 1;
      padding: 3.5vw;
      min-height: 50px;
      border: none;
      border-radius: 0.5rem;
      background: linear-gradient(to right, #800000, #FFD700);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(to right, #FFD700, #800000);
      transform: translateY(-2px);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #photo-preview {
      max-width: 60%;
      border-radius: 0.8rem;
      margin: 3vw auto;
      display: block;
      box-shadow: 0 0.2rem 0.4rem rgba(0, 0, 0, 0.1);
    }
    .success {
      text-align: center;
      padding: 6vw;
      width: 100%;
      max-width: 450px;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      margin: auto;
      animation: fadeIn 0.5s ease;
    }
    .success h2 {
      font-size: 1.6rem;
      color: #800000;
      margin-bottom: 4vw;
    }
    .success p {
      font-size: 1rem;
      margin-bottom: 4vw;
    }
    .success button {
      width: 100%;
      max-width: 250px;
      margin: 0 auto;
    }
    .logout {
      text-align: center;
      margin-top: 4vw;
    }
    .logout a {
      color: #800000;
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .logout a:hover {
      text-decoration: underline;
    }
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      pointer-events: none;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @media (max-width: 600px) {
      .container {
        padding: 8vw;
      }
      .card, .success {
        padding: 8vw;
        border-radius: 0.8rem;
      }
      .progress-bar {
        height: 0.6rem;
      }
      .step-indicator {
        width: 8px;
        height: 8px;
      }
      #step-text {
        font-size: 0.95rem;
      }
      label {
        font-size: 0.95rem;
      }
      input, select {
        padding: 4.5vw;
        font-size: 0.95rem;
      }
      .navigation {
        flex-direction: column;
        gap: 4vw;
      }
      button {
        padding: 4.5vw;
        min-height: 48px;
        font-size: 0.95rem;
      }
      #photo-preview {
        max-width: 80%;
      }
      .success h2 {
        font-size: 1.4rem;
      }
      .success p {
        font-size: 0.9rem;
      }
      .logout a {
        font-size: 0.9rem;
      }
    }
    @media (min-width: 601px) {
      .container {
        padding: 3vw;
      }
      .card, .success {
        padding: 4vw;
      }
      .progress-bar {
        height: 1rem;
      }
      .step-indicator {
        width: 12px;
        height: 12px;
      }
      #step-text {
        font-size: 1.2rem;
      }
      label {
        font-size: 1.1rem;
      }
      input, select {
        padding: 2.5vw;
        font-size: 1.1rem;
      }
      button {
        padding: 2.5vw;
        min-height: 52px;
        font-size: 1.1rem;
      }
      #photo-preview {
        max-width: 50%;
      }
      .success h2 {
        font-size: 1.8rem;
      }
      .success p {
        font-size: 1.1rem;
      }
      .logout a {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="progress-container">
        <div class="step-indicators">
          <span class="step-indicator active"></span>
          <span class="step-indicator"></span>
          <span class="step-indicator"></span>
          <span class="step-indicator"></span>
          <span class="step-indicator"></span>
          <span class="step-indicator"></span>
        </div>
        <div class="progress-bar">
          <div class="progress" id="progress"></div>
        </div>
        <span id="step-text">Step 1 of 6</span>
      </div>
      <form id="details-form" novalidate>
        <!-- Step 1: Basic Info -->
        <div class="step" id="step-1">
          <h2>Basic Information</h2>
          <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" required aria-label="Full Name">
            <span class="error" id="error-name"></span>
          </div>
          <div class="form-group">
            <label>Gender</label>
            <div class="radio-group">
              <label><input type="radio" name="gender" value="Male" required aria-label="Male"> Male</label>
              <label><input type="radio" name="gender" value="Female" aria-label="Female"> Female</label>
            </div>
            <span class="error" id="error-gender"></span>
          </div>
          <div class="form-group">
            <label for="dob">Date of Birth</label>
            <input type="date" id="dob" required aria-label="Date of Birth">
            <span class="error" id="error-dob"></span>
          </div>
          <div class="form-group">
            <label for="marital-status">Marital Status</label>
            <select id="marital-status" required aria-label="Marital Status">
              <option value="">Select</option>
              <option value="Never Married">Never Married</option>
              <option value="Divorced">Divorced</option>
              <option value="Widowed">Widowed</option>
            </select>
            <span class="error" id="error-marital-status"></span>
          </div>
        </div>
        <!-- Step 2: Community Details -->
        <div class="step hidden" id="step-2">
          <h2>Community Details</h2>
          <div class="form-group">
            <label for="caste">Caste</label>
            <input type="text" id="caste" value="Rangrez" disabled aria-label="Caste">
          </div>
          <div class="form-group">
            <label for="subcaste">Subcaste</label>
            <select id="subcaste" required aria-label="Subcaste">
              <option value="">Select</option>
              <option value="Sunni">Sunni</option>
              <option value="Shia">Shia</option>
            </select>
            <span class="error" id="error-subcaste"></span>
          </div>
          <div class="form-group">
            <label for="mother-tongue">Mother Tongue</label>
            <select id="mother-tongue" required aria-label="Mother Tongue">
              <option value="">Select</option>
              <option value="Urdu">Urdu</option>
              <option value="Hindi">Hindi</option>
            </select>
            <span class="error" id="error-mother-tongue"></span>
          </div>
        </div>
        <!-- Step 3: Education & Job -->
        <div class="step hidden" id="step-3">
          <h2>Education & Job</h2>
          <div class="form-group">
            <label for="qualification">Qualification</label>
            <select id="qualification" required aria-label="Qualification">
              <option value="">Select</option>
              <option value="MBA">MBA</option>
              <option value="B.Tech">B.Tech</option>
              <option value="PhD">PhD</option>
            </select>
            <span class="error" id="error-qualification"></span>
          </div>
          <div class="form-group">
            <label for="occupation">Occupation</label>
            <select id="occupation" required aria-label="Occupation">
              <option value="">Select</option>
              <option value="Software Engineer">Software Engineer</option>
              <option value="Doctor">Doctor</option>
              <option value="Teacher">Teacher</option>
            </select>
            <span class="error" id="error-occupation"></span>
          </div>
          <div class="form-group">
            <label for="income">Income</label>
            <select id="income" required aria-label="Income">
              <option value="">Select</option>
              <option value="10-15 LPA">10-15 LPA</option>
              <option value="15-20 LPA">15-20 LPA</option>
              <option value="20+ LPA">20+ LPA</option>
            </select>
            <span class="error" id="error-income"></span>
          </div>
        </div>
        <!-- Step 4: Family Info -->
        <div class="step hidden" id="step-4">
          <h2>Family Information</h2>
          <div class="form-group">
            <label for="father-name">Fatherâ€™s Name</label>
            <input type="text" id="father-name" required aria-label="Fatherâ€™s Name">
            <span class="error" id="error-father-name"></span>
          </div>
          <div class="form-group">
            <label for="mother-name">Motherâ€™s Name</label>
            <input type="text" id="mother-name" required aria-label="Motherâ€™s Name">
            <span class="error" id="error-mother-name"></span>
          </div>
          <div class="form-group">
            <label for="siblings">Number of Siblings</label>
            <input type="number" id="siblings" min="0" required aria-label="Number of Siblings">
            <span class="error" id="error-siblings"></span>
          </div>
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" placeholder="City, State" required aria-label="Location">
            <span class="error" id="error-location"></span>
          </div>
        </div>
        <!-- Step 5: Partner Preferences -->
        <div class="step hidden" id="step-5">
          <h2>Partner Preferences</h2>
          <div class="form-group">
            <label for="age-range-min">Age Range</label>
            <div style="display: flex; gap: 2vw; align-items: center;">
              <input type="number" id="age-range-min" min="18" max="50" value="22" required aria-label="Minimum Age">
              <span>-</span>
              <input type="number" id="age-range-max" min="18" max="50" value="28" required aria-label="Maximum Age">
            </div>
            <span class="error" id="error-age-range"></span>
          </div>
          <div class="form-group">
            <label for="pref-education">Education</label>
            <select id="pref-education" required aria-label="Preferred Education">
              <option value="">Select</option>
              <option value="Graduate">Graduate</option>
              <option value="Postgraduate">Postgraduate</option>
              <option value="Any">Any</option>
            </select>
            <span class="error" id="error-pref-education"></span>
          </div>
          <div class="form-group">
            <label for="pref-job">Job</label>
            <select id="pref-job" required aria-label="Preferred Job">
              <option value="">Select</option>
              <option value="Any">Any</option>
              <option value="Professional">Professional</option>
              <option value="Business">Business</option>
            </select>
            <span class="error" id="error-pref-job"></span>
          </div>
          <div class="form-group">
            <label for="pref-location">Location</label>
            <select id="pref-location" required aria-label="Preferred Location">
              <option value="">Select</option>
              <option value="Hyderabad, Telangana">Hyderabad, Telangana</option>
              <option value="Any">Any</option>
            </select>
            <span class="error" id="error-pref-location"></span>
          </div>
        </div>
        <!-- Step 6: Upload Photo -->
        <div class="step hidden" id="step-6">
          <h2>Upload Photo</h2>
          <div class="form-group">
            <label for="photo">Profile Photo</label>
            <input type="file" id="photo" accept="image/*" required aria-label="Profile Photo">
            <img id="photo-preview" class="hidden" alt="Photo Preview">
            <span class="error" id="error-photo"></span>
          </div>
        </div>
        <!-- Navigation -->
        <div class="navigation">
          <button type="button" id="back-btn" class="hidden" aria-label="Previous Step">Back</button>
          <button type="button" id="next-btn" disabled aria-label="Next Step">Next</button>
        </div>
      </form>
      <div class="logout">
        <a href="file:///C:/Users/sunny/OneDrive/Desktop/matiremony/login/login.html" id="logout-btn" aria-label="Logout">Logout</a>
      </div>
    </div>
  </div>
  <!-- Success Screen -->
  <div class="success hidden" id="success-screen">
    <h2>Profile Completed! ðŸŽ‰</h2>
    <p>Your profile is now live. Start exploring matches!</p>
    <button onclick="window.location.href='dashboard.html'" aria-label="Go to Dashboard">Go to Dashboard</button>
  </div>
  <canvas id="confetti-canvas"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCG8OStEG_Si3ypR0fvRqRDSxkO9qz1fCI",
      authDomain: "rangrezchoice.firebaseapp.com",
      projectId: "rangrezchoice",
      storageBucket: "rangrezchoice.firebasestorage.app",
      messagingSenderId: "586465511498",
      appId: "1:586465511498:web:cbf91f0fc7b99859fcfeb3",
      measurementId: "G-F19WWYW4NS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // imgBB API Key (Move to server-side for production)
    const imgBBKey = "01400454f4aafb70d1c9beddec5cbbc5";

    // Form navigation
    let currentStep = 1;
    const totalSteps = 6;
    const formData = {};

    // DOM elements
    const nextBtn = document.getElementById("next-btn");
    const backBtn = document.getElementById("back-btn");
    const progress = document.getElementById("progress");
    const stepText = document.getElementById("step-text");
    const logoutBtn = document.getElementById("logout-btn");
    const stepIndicators = document.querySelectorAll(".step-indicator");

    // Load saved form data from localStorage
    function loadFormData() {
      const savedData = localStorage.getItem("profileFormData");
      if (savedData) {
        Object.assign(formData, JSON.parse(savedData));
        populateForm();
      }
    }

    // Populate form with saved data
    function populateForm() {
      document.getElementById("name").value = formData.name || "";
      if (formData.gender) {
        document.querySelector(`input[name="gender"][value="${formData.gender}"]`).checked = true;
      }
      document.getElementById("dob").value = formData.dob || "";
      document.getElementById("marital-status").value = formData.maritalStatus || "";
      document.getElementById("subcaste").value = formData.subcaste || "";
      document.getElementById("mother-tongue").value = formData.motherTongue || "";
      document.getElementById("qualification").value = formData.qualification || "";
      document.getElementById("occupation").value = formData.occupation || "";
      document.getElementById("income").value = formData.income || "";
      document.getElementById("father-name").value = formData.family?.father || "";
      document.getElementById("mother-name").value = formData.family?.mother || "";
      document.getElementById("siblings").value = formData.family?.siblings || "";
      document.getElementById("location").value = formData.family?.location || "";
      if (formData.preferences) {
        const [minAge, maxAge] = formData.preferences.age_range?.split("-") || [22, 28];
        document.getElementById("age-range-min").value = minAge;
        document.getElementById("age-range-max").value = maxAge;
        document.getElementById("pref-education").value = formData.preferences.education || "";
        document.getElementById("pref-job").value = formData.preferences.job || "";
        document.getElementById("pref-location").value = formData.preferences.location || "";
      }
    }

    // Save form data to localStorage
    function saveFormData() {
      localStorage.setItem("profileFormData", JSON.stringify(formData));
    }

    // Check authentication state and profile existence
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "file:///C:/Users/sunny/OneDrive/Desktop/matiremony/login/login.html";
      } else {
        formData.email = user.email;
        formData.uid = user.uid;
        try {
          const docRef = doc(db, "users", user.uid);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            window.location.href = "file:///C:/Users/sunny/OneDrive/Desktop/matiremony/login/dashboard.html";
          }
        } catch (error) {
          console.error("Error checking profile:", error);
          let errorMessage = "Error loading profile: ";
          if (error.code === "unavailable") {
            errorMessage += "Unable to connect to the server. Please check your internet connection.";
          } else {
            errorMessage += error.message;
          }
          document.getElementById("error-name").textContent = errorMessage;
        }
      }
    });

    // Logout with confirmation
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      if (!confirm("Are you sure you want to logout? Your form progress will be saved.")) return;
      logoutBtn.textContent = "Logging out...";
      logoutBtn.disabled = true;
      try {
        await signOut(auth);
        localStorage.removeItem("profileFormData");
        window.location.href = "file:///C:/Users/sunny/OneDrive/Desktop/matiremony/login/login.html";
      } catch (error) {
        alert("Logout failed: " + error.message);
        console.error(error);
      } finally {
        logoutBtn.textContent = "Logout";
        logoutBtn.disabled = false;
      }
    });

    // Show/hide steps
    function showStep(step) {
      document.querySelectorAll(".step").forEach((s) => s.classList.add("hidden"));
      document.getElementById(`step-${step}`).classList.remove("hidden");
      progress.style.width = `${(step / totalSteps) * 100}%`;
      stepText.textContent = `Step ${step} of ${totalSteps}`;
      stepIndicators.forEach((indicator, index) => {
        indicator.classList.toggle("active", index < step);
      });
      backBtn.classList.toggle("hidden", step === 1);
      nextBtn.textContent = step === totalSteps ? "Submit" : "Next";
      validateStep(step);
    }

    // Validate step inputs
    function validateStep(step) {
      const stepElement = document.getElementById(`step-${step}`);
      const inputs = stepElement.querySelectorAll("input[required], select[required]");
      let valid = true;
      let error = {};

      // Clear previous errors
      stepElement.querySelectorAll(".error").forEach((el) => (el.textContent = ""));
      inputs.forEach((input) => input.classList.remove("valid", "invalid"));

      // Error-to-input mapping
      const inputMap = {
        "age-range": ["age-range-min", "age-range-max"],
        "gender": ["input[name='gender']"]
      };

      if (step === 1) {
        const name = document.getElementById("name").value.trim();
        if (!name) {
          error.name = "Name is required.";
          valid = false;
        } else if (!/^[a-zA-Z\s]+$/.test(name)) {
          error.name = "Name can only contain letters and spaces.";
          valid = false;
        }
        if (!document.querySelector("input[name='gender']:checked")) {
          error.gender = "Please select a gender.";
          valid = false;
        }
        const dob = new Date(document.getElementById("dob").value);
        const age = (new Date() - dob) / (1000 * 60 * 60 * 24 * 365.25);
        if (!document.getElementById("dob").value) {
          error.dob = "Date of birth is required.";
          valid = false;
        } else if (age < 18) {
          error.dob = "You must be at least 18 years old.";
          valid = false;
        }
        if (!document.getElementById("marital-status").value) {
          error["marital-status"] = "Please select marital status.";
          valid = false;
        }
      } else if (step === 2) {
        if (!document.getElementById("subcaste").value) {
          error.subcaste = "Please select a subcaste.";
          valid = false;
        }
        if (!document.getElementById("mother-tongue").value) {
          error["mother-tongue"] = "Please select a mother tongue.";
          valid = false;
        }
      } else if (step === 3) {
        if (!document.getElementById("qualification").value) {
          error.qualification = "Please select a qualification.";
          valid = false;
        }
        if (!document.getElementById("occupation").value) {
          error.occupation = "Please select an occupation.";
          valid = false;
        }
        if (!document.getElementById("income").value) {
          error.income = "Please select an income range.";
          valid = false;
        }
      } else if (step === 4) {
        const fatherName = document.getElementById("father-name").value.trim();
        const motherName = document.getElementById("mother-name").value.trim();
        const siblings = document.getElementById("siblings").value;
        const location = document.getElementById("location").value.trim();
        if (!fatherName) {
          error["father-name"] = "Fatherâ€™s name is required.";
          valid = false;
        } else if (!/^[a-zA-Z\s]+$/.test(fatherName)) {
          error["father-name"] = "Fatherâ€™s name can only contain letters and spaces.";
          valid = false;
        }
        if (!motherName) {
          error["mother-name"] = "Motherâ€™s name is required.";
          valid = false;
        } else if (!/^[a-zA-Z\s]+$/.test(motherName)) {
          error["mother-name"] = "Motherâ€™s name can only contain letters and spaces.";
          valid = false;
        }
        if (siblings === "") {
          error.siblings = "Number of siblings is required.";
          valid = false;
        } else if (parseInt(siblings) < 0) {
          error.siblings = "Number of siblings cannot be negative.";
          valid = false;
        }
        if (!location) {
          error.location = "Location is required.";
          valid = false;
        } else if (!/^[a-zA-Z\s,]+$/.test(location)) {
          error.location = "Location can only contain letters, spaces, and commas.";
          valid = false;
        }
      } else if (step === 5) {
        const minAge = parseInt(document.getElementById("age-range-min").value);
        const maxAge = parseInt(document.getElementById("age-range-max").value);
        if (!minAge || !maxAge) {
          error["age-range"] = "Please set an age range.";
          valid = false;
        } else if (minAge >= maxAge) {
          error["age-range"] = "Minimum age must be less than maximum age.";
          valid = false;
        }
        if (!document.getElementById("pref-education").value) {
          error["pref-education"] = "Please select preferred education.";
          valid = false;
        }
        if (!document.getElementById("pref-job").value) {
          error["pref-job"] = "Please select preferred job.";
          valid = false;
        }
        if (!document.getElementById("pref-location").value) {
          error["pref-location"] = "Please select preferred location.";
          valid = false;
        }
      } else if (step === 6) {
        const photo = document.getElementById("photo").files[0];
        if (!photo) {
          error.photo = "Please upload a photo.";
          valid = false;
        } else if (!["image/jpeg", "image/png"].includes(photo.type)) {
          error.photo = "Only JPEG or PNG images are allowed.";
          valid = false;
        } else if (photo.size > 5 * 1024 * 1024) {
          error.photo = "Image size must be less than 5MB.";
          valid = false;
        }
      }

      Object.keys(error).forEach((key) => {
        const errorElement = document.getElementById(`error-${key}`);
        if (errorElement) {
          errorElement.textContent = error[key];
        } else {
          console.warn(`Error element not found for key: ${key}`);
        }
        const inputIds = inputMap[key] || [key];
        inputIds.forEach((selector) => {
          const elements = selector.startsWith("input")
            ? document.querySelectorAll(selector)
            : [document.getElementById(selector)];
          elements.forEach((element) => {
            if (element) {
              element.classList.add("invalid");
            } else {
              console.warn(`Input element not found for selector: ${selector}`);
            }
          });
        });
      });

      inputs.forEach((input) => {
        if (input.value && !error[input.id]) {
          input.classList.add("valid");
        }
      });

      nextBtn.disabled = !valid;
    }

    // Collect form data
    function collectFormData() {
      formData.name = document.getElementById("name").value.trim();
      formData.gender = document.querySelector("input[name='gender']:checked")?.value || "";
      formData.dob = document.getElementById("dob").value;
      formData.maritalStatus = document.getElementById("marital-status").value;
      formData.caste = "Rangrez";
      formData.subcaste = document.getElementById("subcaste").value;
      formData.motherTongue = document.getElementById("mother-tongue").value;
      formData.qualification = document.getElementById("qualification").value;
      formData.occupation = document.getElementById("occupation").value;
      formData.income = document.getElementById("income").value;
      formData.family = {
        father: document.getElementById("father-name").value.trim(),
        mother: document.getElementById("mother-name").value.trim(),
        siblings: document.getElementById("siblings").value,
        location: document.getElementById("location").value.trim()
      };
      formData.preferences = {
        age_range: `${document.getElementById("age-range-min").value}-${document.getElementById("age-range-max").value}`,
        education: document.getElementById("pref-education").value,
        job: document.getElementById("pref-job").value,
        location: document.getElementById("pref-location").value
      };
      saveFormData();
    }

    // Upload image to imgBB
    async function uploadToImgBB(file) {
      try {
        const formData = new FormData();
        formData.append("image", file);
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgBBKey}`, {
          method: "POST",
          body: formData
        });
        const result = await response.json();
        if (result.success) return result.data.url;
        throw new Error("Image upload failed: " + result.error?.message || "Unknown error");
      } catch (error) {
        throw new Error("Image upload failed: " + error.message);
      }
    }

    // Save data to Firestore
    async function saveUserData(imageFile) {
      try {
        const user = auth.currentUser;
        if (!user) {
          throw new Error("No authenticated user found. Please log in again.");
        }

        // Upload image to imgBB
        const imageUrl = await uploadToImgBB(imageFile);

        // Save user data to Firestore
        await setDoc(doc(db, "users", user.uid), {
          ...formData,
          photoUrl: imageUrl,
          createdAt: new Date(),
          updatedAt: new Date(),
          uid: user.uid
        }, { merge: true });

        localStorage.removeItem("profileFormData");
        showSuccess();
      } catch (error) {
        let errorMessage = "Error saving data: ";
        if (error.code === "unavailable") {
          errorMessage += "Unable to connect to the server. Your data is saved locally and will sync when you're online.";
        } else if (error.code === "permission-denied") {
          errorMessage += "Insufficient permissions. Please contact support.";
        } else if (error.message.includes("Image upload failed")) {
          errorMessage += "Failed to upload photo. Please try a different image.";
        } else {
          errorMessage += error.message;
        }
        document.getElementById(`error-photo`).textContent = errorMessage;
        console.error(error);
      }
    }

    // Show success screen with confetti
    function showSuccess() {
      document.querySelector(".container").classList.add("hidden");
      document.getElementById("success-screen").classList.remove("hidden");
      try {
        const JSConfetti = window.JSConfetti;
        const confetti = new JSConfetti();
        confetti.addConfetti({
          emojis: ['ðŸŽ‰', 'ðŸ’', 'â¤ï¸'],
          confettiNumber: 100,
          confettiRadius: 6
        });
      } catch (error) {
        console.error("Confetti failed to load:", error);
      }
    }

    // Event listeners
    document.getElementById("details-form").addEventListener("input", () => {
      collectFormData();
      validateStep(currentStep);
    });
    document.getElementById("photo").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const preview = document.getElementById("photo-preview");
        preview.src = URL.createObjectURL(file);
        preview.classList.remove("hidden");
        validateStep(6);
      }
    });

    nextBtn.addEventListener("click", async () => {
      collectFormData();
      if (currentStep < totalSteps) {
        nextBtn.disabled = true;
        nextBtn.textContent = "Loading...";
        setTimeout(() => {
          currentStep++;
          showStep(currentStep);
          nextBtn.disabled = false;
          nextBtn.textContent = currentStep === totalSteps ? "Submit" : "Next";
        }, 300);
      } else {
        nextBtn.disabled = true;
        nextBtn.textContent = "Submitting...";
        try {
          const photo = document.getElementById("photo").files[0];
          await saveUserData(photo);
        } catch (error) {
          document.getElementById("error-photo").textContent = "Error saving profile. Please check your network and try again.";
          console.error(error);
        } finally {
          nextBtn.disabled = false;
          nextBtn.textContent = "Submit";
        }
      }
    });

    backBtn.addEventListener("click", () => {
      if (currentStep > 1) {
        backBtn.disabled = true;
        backBtn.textContent = "Loading...";
        setTimeout(() => {
          currentStep--;
          showStep(currentStep);
          backBtn.disabled = false;
          backBtn.textContent = "Back";
        }, 300);
      }
    });

    // Initialize
    loadFormData();
    showStep(1);
  </script>
</body>
</html>